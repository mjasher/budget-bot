  

<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title> Budget Bot </title>
        <meta name="description" content="Create a budget ">
        <meta name="viewport" content="width=device-width, initial-scale=1">

<!--         <link rel="stylesheet" href="third/normalize.min.css">
        <link rel="stylesheet" href="css/main.css"> -->

		<style type="text/css">
			body, html{
				margin: 0;
				padding: 0;
                overflow-x: hidden;
			}

            .tab-nav{
                text-align: center;
                width: 32%;
                font-size: 30px;
                line-height: 30px;
                display: inline-block;
                color: grey;
                padding-top: 10px;
                padding-bottom: 10px;
            }
            .active{
                color: black;
            }
            .tab{
                width: 100%;
                position: absolute;
                overflow: auto;
            }


            /*categorize*/
            #drop{
                border:2px dashed #bbb;
                -moz-border-radius:5px;
                -webkit-border-radius:5px;
                border-radius:5px;
                padding:25px;
                text-align:center;
                font:20pt bold,"Vollkorn";color:#bbb
            }

            /*visualize*/
            #graph {
                font-size: 13px;
            }

            .axis path, .axis line {
              fill: none;
              stroke: #000;
              shape-rendering: crispEdges;
            }

            .brush .extent {
              stroke: #fff;
              fill-opacity: .125;
              shape-rendering: crispEdges;
            }

            #table svg{
                font-size: 12px;
            }

		</style>

<!--        <script src="third/modernizr-2.6.2.min.js"></script> -->
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

    <div class='nav'>
        <div class='tab-nav' id='categorize-nav'>Categorize</div>
        <div class='tab-nav' id='visualize-nav'>Visualize</div>
        <div class='tab-nav' id='contextualize-nav'>Contextualize</div>
    </div>
    <div class='tabs'>
        <div class='tab' id='categorize'>
            <div id='drop'> Drop CSV files here </div>
            Add csv files containing transactions and categorize each transaction. If some of your added transactions have a category already, we'll try do the rest for you.
        </div>
        <div class='tab' id='visualize'>
            <div id='graph'></div>
            <div id='table'></div>
        </div>
        <div class='tab' id='contextualize'>
            Have a look at the <a href="http://www.abs.gov.au/ausstats/abs@.nsf/mf/6530.0/">Household Expenditure Survey</a> and see how you compare to the "average" Australian.
        </div>
    </div>

<!--
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/jquery-1.11.0.min.js"><\/script>')</script>

        <script src="js/plugins.js"></script>
-->
        <script src="js/d3.min.js"></script>

		<script>


            function openTab(d,i){ 
                    d3.selectAll('.tab')
                        .transition()
                        .duration(500)
                        .style('left', function(d,j){
                            return ((j-i)*100)+'%';
                        })
                    d3.selectAll('.tab-nav')
                        .classed('active', function(d,j){
                            if (i === j) return true;
                            else return false;
                        });
            }

            d3.selectAll('.tab-nav')
                .on('click', openTab);

            openTab(null,1);


function draw_table(){
    
  var unique_dates_values = unique_dates.values().reverse(); // TODO SORT

  // sum for each week/month
  var sums = unique_dates_values.map(function(date){
    var sum = 0;
    for (var i = 0; i < color.domain().length; i++) {
      if( val = nested_by_category.get(color.domain()[i]).get(date) ){
        sum += val.expenses;
      }
    };
    return sum;
  })

  // average for each category
  var averages = color.domain().map(function(c){
    return d3.sum(nested_by_category.get(c).values().map(function(val){
      return val.expenses;
    }))/unique_dates_values.length;
  });


  var w = document.getElementById('graph').clientWidth,
      margin = {top: 40, right: 120, bottom: 20, left: 120},
      x = d3.scale.ordinal().rangeRoundBands([0, w - margin.left - margin.right],.1)
          .domain(unique_dates_values);

          junk = x;
  d3.select('#table svg').remove();
    var table = d3.select('#table').append("svg")
          .attr('width', w)
          .attr('height', 20*color.domain().length + 80)
          .append('g')
          .attr('transform', 'translate('+margin.left+','+margin.top+')');

  // rows
  var tbody = table.selectAll("g")
      .data(color.domain())
      .enter()
      .append("g")
      .attr('transform', function(d,i){ return 'translate(0,'+ (40+i*20) +')'});

  // row colors
  tbody.append('rect')
      .style('fill', function(d,i) { return color(d); })
      .attr('transform', 'translate(0,-18)')
      .attr('width',w - margin.left - margin.right)
      .attr('height', 20);

  // column shades
  table.append("g")
      .selectAll("rect")
      .data(unique_dates_values.filter(function(date,i){return i%2;}))
      .enter()
      .append("rect")
      .attr('transform', function(d,i){ return 'translate('+ x(d) +',20)'})
      .attr('width', x.rangeBand())
      .attr('height', 20*color.domain().length)
      .attr('fill-opacity',0.125);

    // tbody.append('text')
    //   .style('font-weight', 'bold')
    //   .attr('font-size', '15px')
    //   .attr("text-anchor", "end")
    //   .text(function(d,i) { return d; })

    tbody.selectAll("text")
        .data(function(d,i) { 
          // console.log("BEAUTY",d, nested_by_category.get(d).entries());
          return nested_by_category.get(d).entries(); 
         })
        .enter()
        .append('text')
        .attr('class','cell')
        .attr('font-size', x.rangeBand()/3)
        .attr('transform', function(d,i){ return 'translate('+ x(d.key) +',0)'})
        .text( function(d,i) {
            // return d.value.expenses.toFixed();
            return (d.value.expenses != 0) ? d.value.expenses.toFixed() : '';
        })


    // averages
     tbody.append('text')
         .attr('font-size', x.rangeBand()/3)
        .text(function(d,i) { return averages[i].toFixed(); })
        .attr('transform','translate('+ (w - margin.left - margin.right) +',0)')
   
    table
        .append("text")
        .attr('transform', function(d,i){ return 'translate('+ (w - margin.left - margin.right + x.rangeBand()) +',0)rotate(-60)'})
        .attr("text-anchor", "middle")
        .style('font-weight', 'bold')
        // .attr('font-size', '15px')
        .text("AVERAGE");



    // thead
    table.append("g")
        .selectAll("text")
        .data(unique_dates_values)
        .enter()
        .append("text")
        .attr('transform', function(d,i){ return 'translate('+ (x(d)+x.rangeBand()) +',0)rotate(-60)'})
        .attr("text-anchor", "middle")
        .text(function(d) { return d; });

    // sums
    table.append("g")
        .selectAll("text")
        .data(unique_dates_values)
        .enter()
        .append("text")
        .attr('font-size', x.rangeBand()/3)
        .attr('transform', function(d,i){ return 'translate('+ (x(d)) +','+(40+20*color.domain().length)+')'})
        // .attr("text-anchor", "middle")
        .text(function(d,i) { return sums[i].toFixed(); });

    table.append("g")
        .append("text")
        .style('font-weight', 'bold')
        .attr("text-anchor", "end")
        .attr('font-size', '15px')
        .attr('transform','translate('+0 +','+(40+20*color.domain().length)+')')
        // .attr("text-anchor", "middle")
        .text('TOTAL');




        
}


var nested_by_category = d3.map();
var color = d3.scale.category20();
var unique_dates = d3.set();
var unique_categories = d3.set();

// The date format
// var interval = d3.time.month; // https://github.com/mbostock/d3/wiki/Time-Intervals
// var interval_format = d3.time.format("%b");
var interval = d3.time.week;
var interval_format = d3.time.format("%d-%b-%y"); 


function loadCSV(data){
    // var data = d3.csv.parse(data); 

      var dateFormat = d3.time.format("%d-%b-%y"); // https://github.com/mbostock/d3/wiki/Time-Formatting
      
      // TODO auto categorize , make sure we have d.date,amount,category
      for (var i = 0; i < data.length; i++) {
        try{
          data[i].date = dateFormat.parse(data[i].date);
          data[i].amount = +data[i].amount;

          if (data[i].category == '') data[i].category = '-';

          unique_dates.add( interval_format(interval(data[i].date)) ); 
          unique_categories.add( data[i].category ); 

        }
        catch(err){
          console.log("couldn't parse ", data[i].date);
        }
      };


      color.domain(unique_categories.values());

      function rollup(leaves){ 
        return {length: leaves.length, 
                income: d3.sum(leaves, 
                                  function(d) {
                                      if (d.amount > 0) return d.amount;
                                      else return 0;
                                  }),
                expenses: d3.sum(leaves, 
                                  function(d) {
                                      if (d.amount < 0) return -1*d.amount;
                                      else return 0;
                                  })
              } 
      }

      nested_by_category = d3.nest()
        .key(function(d) { return d.category; })
        .key(function(d) { return interval_format(interval(d.date)); })
        .rollup(rollup)
        .map(data, d3.map);


      draw_table();
      // draw();


}



// for degugging purposes
d3.csv('DELETE_THIS.csv', function(data){
  loadCSV(data);
});

		</script>

    </body>
</html>
